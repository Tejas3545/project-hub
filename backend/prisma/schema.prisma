// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  name          String?  // Combined name for NextAuth
  firstName     String?
  lastName      String?
  image         String?  // NextAuth default profile image field
  profileImage  String?  // Keeping for backward compatibility or custom uploads
  bio           String?  @db.Text
  headline      String?  // Professional headline
  location      String?  // User location
  githubUrl     String?  // GitHub profile URL
  portfolioUrl  String?  // Portfolio website URL
  role          UserRole @default(STUDENT)
  isVerified    Boolean  @default(false)
  emailVerified DateTime? // NextAuth field
  passwordHash  String?   // For credential-based auth (Admin/Backend)
  
  // Auth fields
  accounts      Account[]
  sessions      Session[]
  
  lastLogin     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // M3: Gamification & Analytics
  totalTimeSpent Int      @default(0) // Total minutes spent on projects
  currentStreak  Int      @default(0) // Current daily streak
  longestStreak  Int      @default(0) // Longest daily streak
  points         Int      @default(0) // Experience points
  level          Int      @default(1) // User level (based on points)
  lastActiveDate DateTime? // Last day user was active
  
  bookmarks     Bookmark[]
  progress      ProjectProgress[]
  githubProgress GitHubProjectProgress[]
  createdProjects Project[] @relation("UserProjects")
  comments      Comment[]
  likes         Like[]
  notifications Notification[]
  timeSessions  TimeSession[]
  projectNotes  ProjectNote[]
  deadlines     Deadline[]
  achievements  UserAchievement[]

  @@map("users")
}

model Account {
  id                 String  @id @default(uuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?  @db.Text
  access_token       String?  @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?  @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Domain {
  id             String          @id @default(uuid())
  name           String          @unique
  slug           String          @unique
  description    String?
  projects       Project[]
  githubProjects GitHubProject[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@map("domains")
}

model Project {
  id                    String     @id @default(uuid())
  title                 String
  createdById           String?
  createdBy             User?      @relation("UserProjects", fields: [createdById], references: [id], onDelete: SetNull)
  domainId              String
  domain                Domain     @relation(fields: [domainId], references: [id], onDelete: Cascade)
  subDomain             String?    // Sub-domain within the main domain
  difficulty            Difficulty
  minTime               Int        // in hours
  maxTime               Int        // in hours
  skillFocus            String[]
  
  // Real-World Solution Framework Fields
  caseStudy             String?    @db.Text  // The Story (3-4 sentences about persona & situation)
  problemStatement      String     @db.Text  // Core technical/logical gap
  solutionDescription   String?    @db.Text  // High-level explanation of what project builds
  techStack             String[]   @default([]) // Recommended technologies
  supposedDeadline      String?    // Realistic timeframe (e.g., "1-2 Weeks")
  
  // M2 Enhancement Fields
  screenshots           String[]   @default([]) // Cloudinary URLs for project screenshots
  initializationGuide   String?    @db.Text  // Step-by-step setup guide with code snippets
  
  // Legacy fields (keeping for backwards compatibility)
  industryContext       String     @db.Text
  scope                 String     @db.Text
  prerequisites         String[]
  deliverables          String[]
  requirements          String[]   @default([]) // Specific technical requirements
  requirementsText      String?    @db.Text    // Detailed requirements description
  advancedExtensions    String?    @db.Text
  evaluationCriteria    String?    @db.Text
  
  isPublished           Boolean    @default(false)
  deletedAt             DateTime?
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt
  
  bookmarks             Bookmark[]
  progress              ProjectProgress[]
  comments              Comment[]
  likes                 Like[]

  @@index([domainId])
  @@index([createdById])
  @@index([difficulty])
  @@index([isPublished])
  @@index([createdAt])
  @@map("projects")
}

model Bookmark {
  id              String         @id @default(uuid())
  userId          String
  projectId       String?
  githubProjectId String?
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  project         Project?       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  githubProject   GitHubProject? @relation(fields: [githubProjectId], references: [id], onDelete: Cascade)
  createdAt       DateTime       @default(now())

  @@unique([userId, projectId])
  @@unique([userId, githubProjectId], name: "userId_githubProjectId")
  @@index([userId])
  @@index([projectId])
  @@index([githubProjectId])
  @@map("bookmarks")
}

model ProjectProgress {
  id                    String         @id @default(uuid())
  userId                String
  projectId             String
  user                  User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  project               Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  status                ProgressStatus @default(NOT_STARTED)
  startedAt             DateTime?
  completedAt           DateTime?
  timeSpent             Int            @default(0) // in minutes
  isRunning             Boolean        @default(false)
  lastTimerStart        DateTime?      // M3: When current timer session started
  targetCompletionDate  DateTime?
  notes                 String?        @db.Text
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  @@unique([userId, projectId])
  @@index([userId])
  @@index([projectId])
  @@index([status])
  @@map("project_progress")
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  ON_HOLD
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EASY
  MEDIUM
  HARD
}

enum QaStatus {
  PENDING
  APPROVED
  REJECTED
  NEEDS_REWORK
}

enum UserRole {
  STUDENT
  ADMIN
}

model Comment {
  id        String   @id @default(uuid())
  userId    String
  projectId String
  text      String   @db.Text
  parentId  String?
  parent    Comment?  @relation("CommentToComment", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentToComment")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  upvotes   Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([projectId])
  @@index([parentId])
  @@map("comments")
}

model Like {
  id        String   @id @default(uuid())
  userId    String
  projectId String?
  commentId String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, projectId])
  @@index([userId])
  @@index([projectId])
  @@map("likes")
}

model Notification {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  message         String   @db.Text
  type            NotificationType
  relatedProjectId String?
  isRead          Boolean  @default(false)
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

enum NotificationType {
  NEW_COMMENT
  NEW_UPVOTE
  PROJECT_APPROVED
  PROJECT_REJECTED
}

model GitHubProject {
  id            String     @id @default(uuid())
  title         String
  slug          String?    @unique // URL-friendly identifier (optional during migration)
  description   String     @db.Text
  repoUrl       String
  repoOwner     String?    // GitHub username/org (e.g., "OWASP")
  repoName      String?    // Repository name (e.g., "NodeGoat")
  defaultBranch String     @default("main") // main, master, etc.
  downloadUrl   String     @default("") // Direct ZIP download URL from GitHub
  liveUrl       String?    // Live demo/deployed application URL
  downloadCount Int        @default(0) // Track download analytics
  domainId      String
  domain        Domain     @relation(fields: [domainId], references: [id], onDelete: Cascade)
  stars         Int        @default(0)
  forks         Int        @default(0)
  language      String?
  techStack     String[]
  difficulty    Difficulty @default(MEDIUM)
  topics        String[]
  lastUpdated   DateTime?
  isActive      Boolean    @default(true)
  
  // Client Required Fields (Production-Level Documentation)
  author             String    @default("Project Hub") // Project author
  introduction       String?   @db.Text // 150-250 word project overview
  implementation     String?   @db.Text // Technical explanation, workflow, architecture
  technicalSkills    String[]  @default([]) // Languages, concepts, algorithms, frameworks
  toolsUsed          String[]  @default([]) // IDEs, platforms, databases, third-party tools
  conceptsUsed       String[]  @default([]) // Programming concepts applied
  
  // Real-World Solution Framework Fields (Client Requirement - 7 Mandatory Sections)
  // 1. Project Title - (covered by 'title')
  // 2. Domain & Sub-domain
  subDomain          String?   // e.g., "Frontend", "Backend", "Full-stack", "Web Scraping", etc.
  
  // 3. Difficulty Level - (covered by 'difficulty')
  // 4. Industry Context / Case Study
  caseStudy          String?   @db.Text // The Story (3-4 sentences about persona & situation)
  
  // 5. Problem Statement
  problemStatement   String?   @db.Text // Core technical/logical gap and challenge
  
  // 6. What You Need to Build / Do
  solutionDescription String?  @db.Text // High-level explanation of what project builds
  
  // 7. Prerequisites
  prerequisites      String[]  @default([]) // Fundamental concepts student must know
  
  // Prerequisites in text format (full description)
  prerequisitesText  String?   @db.Text // Detailed prerequisites description
  
  // Estimated Time Commitment (min/max)
  estimatedMinTime   Int       @default(10) // in hours
  estimatedMaxTime   Int       @default(40) // in hours
  
  // Deliverables (what student submits)
  deliverables       String[]  @default([]) // Specific items: code, docs, reports, dashboards, deployments
  
  // Project deadline suggestion
  supposedDeadline   String?   // Realistic timeframe (e.g., "1 Week", "2 weeks")
  
  // Optional Extensions (for advanced students)
  optionalExtensions String?   @db.Text // Advanced features or enhancements students can add
  
  requirements       String[]  @default([]) // Specific technical requirements
  requirementsText   String?   @db.Text    // Detailed requirements description
  
  // Evaluation Criteria (how student's work is graded)
  evaluationCriteria String?   @db.Text // Clear success metrics and grading rubric
  
  // Internal QA Workflow
  qaStatus           QaStatus  @default(PENDING)
  qaFeedback         String?   @db.Text
  reviewedAt         DateTime?
  reviewedBy         String?

  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  sourceCode    ProjectSourceCode?
  progress      GitHubProjectProgress[]
  bookmarks     Bookmark[]

  @@index([domainId])
  @@index([difficulty])
  @@index([stars])
  @@index([isActive])
  @@index([language])
  @@index([slug])
  @@map("github_projects")
}

model ProjectSourceCode {
  id              String        @id @default(uuid())
  githubProjectId String        @unique
  githubProject   GitHubProject @relation(fields: [githubProjectId], references: [id], onDelete: Cascade)
  downloadUrl     String        // Direct download link
  repositoryUrl   String?       // GitHub repository URL
  fileSize        Int?          // File size in bytes
  techStack       String[]      @default([]) // Technologies used
  hasReadme       Boolean       @default(true) // Has README.md
  hasRequirements Boolean       @default(true) // Has requirements/dependencies file
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([githubProjectId])
  @@map("project_source_code")
}

// ================================
// GitHub Project Progress Tracking
// ================================

model GitHubProjectProgress {
  id                    String         @id @default(uuid())
  userId                String
  githubProjectId       String
  user                  User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  githubProject         GitHubProject  @relation(fields: [githubProjectId], references: [id], onDelete: Cascade)
  status                ProgressStatus @default(IN_PROGRESS)
  startedAt             DateTime       @default(now())
  completedAt           DateTime?
  timeSpent             Int            @default(0) // in seconds
  notes                 String?        @db.Text
  checklist             Boolean[]      @default([])
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  @@unique([userId, githubProjectId])
  @@index([userId])
  @@index([githubProjectId])
  @@index([status])
  @@map("github_project_progress")
}

// ================================
// M3: Workspace & Tracking Models
// ================================

// Time tracking sessions for individual work periods
model TimeSession {
  id          String   @id @default(uuid())
  userId      String
  projectId   String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  startTime   DateTime
  endTime     DateTime?
  duration    Int      @default(0) // in minutes (calculated on stop)
  notes       String?  @db.Text
  isActive    Boolean  @default(true) // true if timer is running
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([projectId])
  @@index([startTime])
  @@map("time_sessions")
}

// Project-specific notes and workspace content
model ProjectNote {
  id          String   @id @default(uuid())
  userId      String
  projectId   String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String   @default("Untitled Note")
  content     String   @db.Text
  isPinned    Boolean  @default(false)
  tags        String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([projectId])
  @@index([isPinned])
  @@map("project_notes")
}

// User-defined deadlines for projects
model Deadline {
  id           String   @id @default(uuid())
  userId       String
  projectId    String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title        String
  description  String?  @db.Text
  dueDate      DateTime
  isCompleted  Boolean  @default(false)
  priority     DeadlinePriority @default(MEDIUM)
  reminderSent Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([projectId])
  @@index([dueDate])
  @@index([isCompleted])
  @@map("deadlines")
}

enum DeadlinePriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// Achievement/Badge definitions
model Achievement {
  id          String   @id @default(uuid())
  name        String   @unique
  description String   @db.Text
  icon        String   // Icon name or URL
  category    AchievementCategory
  requirement Int      // Points/count needed to unlock
  points      Int      @default(0) // Points awarded when earned
  createdAt   DateTime @default(now())
  
  users       UserAchievement[]

  @@map("achievements")
}

enum AchievementCategory {
  TIME_TRACKING    // Hours logged
  PROJECTS         // Projects completed
  STREAK          // Login streaks
  SOCIAL          // Likes, comments
  LEARNING        // Skills acquired
  SPECIAL         // Special events
}

// User's earned achievements
model UserAchievement {
  id            String      @id @default(uuid())
  userId        String
  achievementId String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  earnedAt      DateTime    @default(now())

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
  @@map("user_achievements")
}

// Learning path recommendations
model LearningPath {
  id          String   @id @default(uuid())
  title       String
  description String   @db.Text
  difficulty  Difficulty
  domains     String[] // Related domains
  projectIds  String[] // Recommended project sequence
  estimatedTime Int    // in hours
  skills      String[] // Skills learned
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([difficulty])
  @@index([isActive])
  @@map("learning_paths")
}
